#!/bin/bash
#
# Sparrow Browser - Launcher Universal
# Ejecuta Sparrow con configuración automática de display
#

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Función para detectar y configurar display
setup_display() {
    # Intentar obtener variables de Xwayland
    local xwayland_pid=$(pgrep -u $USER Xwayland 2>/dev/null | head -1)
    
    if [ -n "$xwayland_pid" ]; then
        export DISPLAY=$(cat /proc/$xwayland_pid/environ 2>/dev/null | tr '\0' '\n' | grep "^DISPLAY=" | cut -d= -f2)
        export XAUTHORITY=$(cat /proc/$xwayland_pid/environ 2>/dev/null | tr '\0' '\n' | grep "^XAUTHORITY=" | cut -d= -f2)
        export XDG_RUNTIME_DIR=/run/user/$(id -u)
        return 0
    fi
    
    # Si no hay Xwayland, intentar con DISPLAY existente
    if [ -n "$DISPLAY" ]; then
        return 0
    fi
    
    return 1
}

# Cambiar al directorio del script
cd "$(dirname "$0")"

# Modo silencioso si se pasa --quiet
QUIET=false
if [ "$1" = "--quiet" ] || [ "$1" = "-q" ]; then
    QUIET=true
fi

# Banner (solo si no es modo silencioso)
if [ "$QUIET" = false ]; then
    echo "=========================================="
    echo "  Sparrow Browser - Experimental Fork"
    echo "=========================================="
    echo ""
fi

# Configurar display
if ! setup_display; then
    echo -e "${RED}❌ Error: No se pudo configurar el display${NC}"
    echo ""
    echo "Ejecuta desde una terminal GNOME (Ctrl+Alt+T)"
    exit 1
fi

# Verificar conexión al display (solo si no es modo silencioso)
if [ "$QUIET" = false ]; then
    if xdpyinfo >/dev/null 2>&1; then
        echo -e "${GREEN}✅ Display configurado correctamente${NC}"
    else
        echo -e "${YELLOW}⚠️  Advertencia: No se pudo verificar display${NC}"
    fi
    echo ""
fi

# Verificar que el binario existe
if [ ! -f "./build/jpackage/Sparrow/bin/Sparrow" ]; then
    if [ "$QUIET" = false ]; then
        echo "Compilando binario jpackage (primera vez)..."
        ./gradlew clean jpackage
        echo ""
    else
        ./gradlew clean jpackage >/dev/null 2>&1
    fi
fi

# Ejecutar Sparrow
if [ "$QUIET" = false ]; then
    echo "Iniciando Sparrow Wallet..."
    echo ""
fi

exec ./build/jpackage/Sparrow/bin/Sparrow "$@"
